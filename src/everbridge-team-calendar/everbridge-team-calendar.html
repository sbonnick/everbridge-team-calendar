<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/scheduler-component/scheduler-component.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../moment-import.html">

<dom-module id="everbridge-team-calendar">
  <template>
    <style>
      :host {
        display: block;
      }
      #scheduleContainer {
        width: 70%;
      }
      paper-dropdown-menu {
        width: 300px;
     }
     paper-listbox {
        width: 300px;
     }
    </style>

    <iron-ajax id="envars"
      auto 
      url="env.json" 
      handle-as="json" 
      last-response="{{env}}">
    </iron-ajax>

    <iron-ajax id="PostSub"
      url="{{_formatSubstitutionURL(uri, calendarid)}}"
      method="POST"
      content-type="application/json"
      handle-as="json"
      on-response="_handleSuccessSub"
      on-error="_handleFailedSub">
    </iron-ajax>

    <iron-ajax id="getGroups" 
      auto 
      url="{{_formatGroupURL(uri, contactgroup)}}" 
      handle-as="json" 
      on-response="_handleGroupData" 
      debounce-duration="300">
    </iron-ajax>
    
    <iron-ajax id="getAssignment" 
      auto 
      url="{{_formatAssignmentURL(uri, calendarid, date, days)}}" 
      handle-as="json" 
      on-response="_handleAssignmentData" 
      debounce-duration="300">
    </iron-ajax>
    
    <!--
    <iron-ajax id="getSubstitution" 
      auto 
      url="{{_formatSubstitutionURL(uri, calendarid, date, days)}}" 
      handle-as="json" 
      on-response="_handleSubstitutionData" 
      debounce-duration="300"> 
    </iron-ajax>
    -->

    <paper-dialog id='modal' modal>
      <h2>[[_modalData.title]]</h2>
      <h4>[[_modalData.cleaned.startTz]]  --->  [[_modalData.cleaned.endTz]]</h4>
      <paper-dropdown-menu label="Replacement Staff">
        <paper-listbox id='staffSelect' slot="dropdown-content" attr-for-selected="value">
          <template is="dom-repeat" items="[[staff]]">
            <paper-item value="[[item.id]]">[[item.name]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </paper-dialog>

    <div id="scheduleContainer">
      <scheduler-component
        id='schedulerComponent'
        default-view="month"
        show-categories
        weekends
        height=800
        all-day-text="All Day"
        event-color="#378006"
        text-color="#ecf0f1"
        categories={{staff}}
        events={{events}}
        header=''>
      </scheduler-component>
    <div/>
  </template>

  

  <script>

    const _COLORS = [
    "#F44336", "#9C27B0", "#2196F3", "#009688", "#4CAF50", "#FF9800",
    "#795548", "#9E9E9E", "#000000", "#E91E63", "#673AB7", "#00BCD4", 
    "#8BC34A", "#FFC107", "#607D8B", "#3F51B5", "#FF5722",  "#FFEB3B"
    ]

    function getColor(count) {
      var remainder = count % _COLORS.length;
      return _COLORS[remainder];
    }

    /**
     * @customElement
     * @polymer
     */
    class everbridgeTeamCalendar extends Polymer.Element {
      static get is() { return 'everbridge-team-calendar'; }
      static get properties() {
        return {
          env: {
            type: Object
          },
          uri: {
            type: String,
            computed: '_setUri(env)'
          },
          contactgroup: {
            type: String,
            computed: '_setContactGroup(env)'
          },
          calendarid: {
            type: String,
            computed: '_setCalendarId(env)'
          },
          date: {
            type: String,
            value: "2017-01-01"
          },
          days: {
            type: String,
            value: "365"
          },
          categories: {
            type: Object,
            value: []
          },
          events: {
            type: Object,
            value: [],
            computed: '_computeEvents(_events, staff)'
          },
          staff: {
            type: Object,
            value: []
          },
          substitutions: {
            type: Object,
            value: []
          },
          _events: Object
        };
      }
      
      ready() {
        super.ready();
        this.$.schedulerComponent.addEventListener('event-click', e => {this._handleClick(e)});
        this.$.modal.addEventListener('iron-overlay-closed', e => {this._closedDialog(e)});
      }


      // Build Environment Variables

      _setUri(env) { return env.uri }
      _setContactGroup(env) { return env.contactGroup }
      _setCalendarId(env) { return env.calendarId }


      // URL Formatting Rules

      _formatAssignmentURL(uri, calendarid, date, days) {
        return uri + "calendars/"+ calendarid + "/assignment/" + date + "/" + days
      }

      _formatSubstitutionURL(uri, calendarid, date=null, days=null) {
        if (date == null || days == null) {
          return uri + "calendars/"+ calendarid + "/substitutions/"
        }
        return uri + "calendars/"+ calendarid + "/substitutions/" + date + "/" + days
      }

      _formatGroupURL(uri, contactgroup) {
        return uri + "contacts/" + contactgroup
      }


      // Handling actions against clicking a user

      _handleClick(e) {
        var data = e.detail.calEvent;
        data.cleaned ={
          startTz: moment(data.raw.shiftApplicabilityIntervalFrom).tz('America/New_York').format('lll'),
          endTz:   moment(data.raw.shiftApplicabilityIntervalTo).tz('America/New_York').format('lll')
        }
        this._modalData = data;
        this.$.modal.open();
      }

      _closedDialog(e) {
        if (!e.detail.confirmed)  return;
        if (this._modalData.raw.staffContactid === this.$.staffSelect.selectedItem.value)  return;

        this.$.PostSub.body = {
          contactId:     this._modalData.raw.staffContactid,
          replacementId: this.$.staffSelect.selectedItem.value,
          start:         this._modalData.raw.shiftApplicabilityIntervalFrom,
          end:           this._modalData.raw.shiftApplicabilityIntervalTo
        };
        this.$.PostSub.generateRequest();
      }

      _handleSuccessSub(e) {
        this.$.getAssignment.generateRequest();
      }

      _handleFailedSub(e) {
        console.error("Failed to create Sub");
      }


      _getStaffById(id) {
        this.staff.forEach(function(staff) {
          if (staff.id == id) return staff;
        })
      }


      _handleGroupData(data) {
        var tempStaff = [];
        var colorIndex = 0;
        data.detail.response.data.forEach(function(staff) {
          tempStaff.push({
            id:      staff.id,
            name:    staff.firstName + " " + staff.lastName,
            label:   staff.firstName + " " + staff.lastName,
            color:   getColor(colorIndex),
            hidden:  false
          });
          colorIndex ++;
        });
        this.staff = tempStaff;
      }

      _handleAssignmentData(data) {
        var tempEvents = [];
        data.detail.response.data.forEach(function(staff) {
          staff.shiftAssignments.forEach(function(shift) {
            tempEvents.push({
              allDay: true,
              title:    staff.firstName + " " + staff.lastName,
              start:    shift.shiftApplicabilityIntervalFrom,
              category: staff.firstName + " " + staff.lastName,
              raw:      shift
            });
          })
        })
        this._events = tempEvents;
      }

      _computeEvents(_events, staff) {
        if (staff == null || _events == null) return [];
        return _events;
      }

      _handleSubstitutionData(data) {
        this.substitutions = data.detail.response.data;
      }
    }

    window.customElements.define(everbridgeTeamCalendar.is, everbridgeTeamCalendar);
  </script>
</dom-module>
